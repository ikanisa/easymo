#!/bin/bash

# AI Agents Deployment Script
# This script deploys all AI agent functions to Supabase

set -e

echo "ü§ñ AI Agents Deployment Script"
echo "================================"
echo ""

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if OPENAI_API_KEY is set
if [ -z "$OPENAI_API_KEY" ]; then
    echo -e "${RED}‚ùå OPENAI_API_KEY is not set${NC}"
    echo "Please set it in your .env file or export it:"
    echo "export OPENAI_API_KEY=your_key_here"
    exit 1
fi

echo -e "${GREEN}‚úì${NC} OPENAI_API_KEY is set"

# Function to deploy a function
deploy_function() {
    local func_name=$1
    local func_path=$2
    
    echo ""
    echo -e "${YELLOW}‚Üí${NC} Deploying $func_name..."
    
    if supabase functions deploy "$func_path" --no-verify-jwt 2>&1 | tee /tmp/deploy_output.txt; then
        echo -e "${GREEN}‚úì${NC} $func_name deployed successfully"
        return 0
    else
        echo -e "${RED}‚ùå${NC} Failed to deploy $func_name"
        cat /tmp/deploy_output.txt
        return 1
    fi
}

# Set secrets for all functions
echo ""
echo "üìù Setting function secrets..."
supabase secrets set OPENAI_API_KEY="$OPENAI_API_KEY" || echo "Warning: Could not set OPENAI_API_KEY secret"

# Deploy agents
echo ""
echo "üöÄ Deploying AI Agents..."
echo "-------------------------"

FAILED=()

# Property Rental Agent
if ! deploy_function "Property Rental Agent" "agents/property-rental"; then
    FAILED+=("property-rental")
fi

# Schedule Trip Agent
if ! deploy_function "Schedule Trip Agent" "agents/schedule-trip"; then
    FAILED+=("schedule-trip")
fi

# Quincaillerie Agent
if ! deploy_function "Quincaillerie Agent" "agents/quincaillerie"; then
    FAILED+=("quincaillerie")
fi

# Shops Agent
if ! deploy_function "Shops Agent" "agents/shops"; then
    FAILED+=("shops")
fi

# Summary
echo ""
echo "================================"
echo "üìä Deployment Summary"
echo "================================"

if [ ${#FAILED[@]} -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All agents deployed successfully!${NC}"
    echo ""
    echo "Next steps:"
    echo "1. Test the agents using: npm run test:agents"
    echo "2. Check logs: supabase functions logs <function-name>"
    echo "3. Integrate with WhatsApp webhook"
else
    echo -e "${RED}‚ùå Some deployments failed:${NC}"
    printf '%s\n' "${FAILED[@]}"
    echo ""
    echo "To retry failed deployments:"
    for func in "${FAILED[@]}"; do
        echo "  supabase functions deploy agents/$func"
    done
    exit 1
fi

echo ""
echo "üéâ Deployment complete!"
