# Alert Definitions for EasyMO WhatsApp Webhook Services

alerts:
  - name: ServiceDown
    severity: critical
    description: "Service health check failing"
    condition: |
      health_check_status != "healthy" for 2 minutes
    services:
      - wa-webhook-core
      - wa-webhook-profile
      - wa-webhook-mobility
      - wa-webhook-insurance
    action: |
      1. Check service logs
      2. Verify database connectivity
      3. Check for recent deployments
      4. Restart service if needed
    notification:
      - pagerduty: critical
      - slack: "#easymo-alerts"

  - name: DatabaseDown
    severity: critical
    description: "Database connectivity lost"
    condition: |
      health_check_database == "disconnected" for 1 minute
    action: |
      1. Check Supabase status page
      2. Verify network connectivity
      3. Check for database maintenance
    notification:
      - pagerduty: critical
      - slack: "#easymo-alerts"

  - name: HighLatency
    severity: warning
    description: "Request latency exceeds threshold"
    condition: |
      p99_latency_ms > 2000 for 5 minutes
    thresholds:
      warning: 1500ms
      critical: 3000ms
    notification:
      - slack: "#easymo-alerts"

  - name: HighErrorRate
    severity: warning
    description: "Error rate exceeds threshold"
    condition: |
      error_rate > 0.05 for 5 minutes
    thresholds:
      warning: 5%
      critical: 10%
    notification:
      - slack: "#easymo-alerts"

  - name: LowCacheHitRate
    severity: warning
    description: "Cache hit rate below threshold"
    condition: |
      cache_hit_rate < 0.5 for 15 minutes
    thresholds:
      warning: 50%
      critical: 30%
    notification:
      - slack: "#easymo-alerts"

  - name: NoMessagesProcessed
    severity: warning
    description: "No webhook messages processed"
    condition: |
      webhook_messages_total == 0 for 30 minutes
      AND time_of_day BETWEEN 06:00 AND 22:00
    notification:
      - slack: "#easymo-alerts"

  - name: HighAuthFailures
    severity: warning
    description: "High rate of authentication failures"
    condition: |
      auth_failure_rate > 0.1 for 5 minutes
    notification:
      - slack: "#easymo-security"
      - pagerduty: warning
