# Go-Live Readiness Baseline (Phase 0)

_Generated: 2025-10-18 (phase 0); updated after Phase 1 alignment_

This note captures the current state of the EasyMO repository and the configuration artefacts we can audit locally. It serves as the starting point for the multi-phase go-live plan.

## 1. Repository & Branches

- `main` is up to date with `origin/main` (checked out and rebased before starting work).
- Branch `phase2-setup` continues to exist with additional commits; no changes were merged into `main` as part of this pass.
- Working tree is clean after restoring an accidental change to `admin-app/package-lock.json`.

## 2. Environment Artefacts

- **Root `.env`** now targets the live Supabase project (`lhbowpbcpwoiparwnwgt`) and ships only placeholders (`CHANGEME_*`). Copy to `.env.local` and inject real secrets per Phase 1 guidance.
- **`.env.local`** (generated by Vercel CLI) continues to hold the production values (`NEXT_PUBLIC_SUPABASE_URL`, `ADMIN_ACCESS_CREDENTIALS`, etc.). Rotate these secrets into Vercel/Supabase and remove the file from disk once centralised management is in place.
- **`.env.example` / `docs/env/env.sample`** mirror the new structure so future environments start from the correct project ID.
- **`.vercel/project.json`** confirms the linked project ID (`prj_OR78kyqEL69DwKpsNI5dCAoOS5HY`) but does not expose environment variables.
- **`.supabase/access-token`** indicates the CLI is authenticated locally; however, without the corresponding service role password we can’t run remote introspection commands yet.

## 3. Supabase Local Config Snapshot

From `supabase/config.toml`:

- `project_id = "lhbowpbcpwoiparwnwgt"` ✅
- `[auth] site_url` remains `http://localhost:56311` with no additional redirect URLs configured. The Supabase dashboard must be updated to production/preview URLs before go-live.
- Database major version is 17; ports are default (57322/57323 shadow).
- No storage buckets are declared here—these are managed remotely.

## 4. Policies, Cron, Storage – What We Can Infer

- A scan of the migrations shows **55 occurrences** of `enable row level security`. This confirms intent, but we still need to verify the live database actually has RLS enabled/policies applied (requires Supabase CLI access with service credentials).
- We do not have local evidence of storage bucket creation. Environment variables reference `insurance-docs`, `kyc-documents`, `menu-source-files`, `ocr-json-cache`, suggesting the expected bucket names. Confirmation must happen in the Supabase dashboard.
- Cron schedules (e.g., for reminder functions) cannot be listed without `SUPABASE_ACCESS_TOKEN`/`SUPABASE_DB_URL`. Phase 1 should explicitly run `supabase cron list` and capture the current configuration.
- Edge functions are present in the repo (`supabase/functions/*`), but we haven’t exercised them yet. Testing will happen in Phase 3.

## 5. Phase 1 Adjustments Completed

- Replaced the tracked `.env` with a sanitized template targeting the active Supabase project (`lhbowpbcpwoiparwnwgt`) and documented every required variable. `.env.example` mirrors the new structure.
- Added `docs/env/phase2-env-alignment.md` with a full checklist for synchronising Vercel, Supabase edge function secrets, and admin session tokens.
- Updated `supabase/config.toml` so that the local auth configuration mirrors the desired production Site URL (`https://easymo.vercel.app`) and includes preview/local redirect URLs.
- Confirmed that `.env.local` still holds the live secrets; these should be rotated into the secret manager when ready.

## 6. Phase 2 Progress (Data & Storage)

- Added `supabase/migrations/20251018143000_storage_bucket_setup.sql` to ensure the buckets required by the admin panel (`insurance-docs`, `kyc-documents`, `menu-source-files`, `ocr-json-cache`, `vouchers`) are created automatically during migration.
- Introduced two idempotent seed scripts:
  - `supabase/seed/fixtures/admin_panel_core.sql` (auth users, profiles, settings, driver presence, trips, subscriptions).
  - `supabase/seed/fixtures/admin_panel_marketing.sql` (campaigns, voucher targets, vouchers, voucher events, orders, insurance leads).
- Run both scripts after `supabase db push` to light up the admin dashboard with meaningful data. Each script can be re-run without harming existing fixtures thanks to `ON CONFLICT` guards.
- Applied the latest seeds against project `lhbowpbcpwoiparwnwgt` on 2025-10-18 using the service `postgresql://postgres:<db-password>@…` credentials. Seeds required the new migration `20251205100000_admin_marketing_fixture_support.sql`, which adds unique indexes (`campaign_targets_campaign_msisdn_key`, `vouchers_code5_key`) and a `campaigns_legacy_id_seq` default so future environments stay idempotent.
- Added migration `20251206090000_driver_vehicle_defaults.sql` to persist `profiles.vehicle_plate` and `profiles.vehicle_type`. The WhatsApp driver flows now prompt once for plate + vehicle type, store the defaults, and reuse them for subsequent “Nearby passengers” or scheduling. The simulator mirrors this behavior and exposes a “Change vehicle type” control.
- Added migration `20251206103000_agent_chat_tables.sql` to capture broker/support chat transcripts (`agent_chat_sessions`, `agent_chat_messages`). The Admin Marketplace and Operations screens can now preview the agent chat UI when `ENABLE_AGENT_CHAT=1` is set.

## 7. Outstanding Information (Phase 3 follow-up)

| Area                | Action                                                                                              |
|---------------------|-----------------------------------------------------------------------------------------------------|
| Vercel environment  | Export current env vars (especially admin tokens, dispatcher URL) and reconcile with `.env.local`. |
| Supabase auth       | Update Site URL & Redirect URLs directly in the Supabase dashboard (pending access).               |
| Storage             | List existing buckets and create missing ones (`vouchers`, `kyc-documents`, etc.).                 |
| Cron jobs           | Supabase CLI v2.51 does not expose `functions schedule list`; confirm reminder/notification schedules via the Supabase dashboard and record the results. |
| RLS verification    | Run policy audits against the live database (e.g., `supabase db remote commit` or custom queries). |

## 8. Phase 3 Progress (Edge Functions & Cron)

- Secret alignment: `EASYMO_ADMIN_TOKEN` and `ADMIN_TOKEN` now carry the same value on Supabase (via `supabase secrets set`), Vercel, and `.env.local`.
- Redeployed `admin-*` functions plus `campaign-dispatch` so every endpoint accepts `Authorization: Bearer <service-role>` and `x-admin-token` (or `x-api-key`) headers.
- Added `scripts/test-functions.sh` to automate the curl smoke-tests used during verification; it checks `admin-health`, `admin-settings`, `admin-stats`, `admin-users`, `admin-subscriptions`, `admin-trips`, and `campaign-dispatch`.
- Remote tests confirm all endpoints return HTTP 200 with meaningful payloads when called with the new header contract.
- Cron schedules still require a manual dashboard review—use the new `docs/admin/cron_runbook.md` to capture the results once CLI access is available.
- GitHub Actions workflow `.github/workflows/synthetic-checks.yml` now runs `node scripts/health-check.mjs` (requires secrets `SUPABASE_API_BASE` and `EASYMO_ADMIN_TOKEN`) alongside the Deno synthetic probes to keep the admin Edge functions monitored.

This baseline completes Phase 0: we have the current artefacts catalogued and gaps identified so that Phase 1 can focus on aligning environment variables and authentication.

## 9. Phase 4/5 Progress (Realtime + Marketplace)

- Added service manifests (`docker-compose.agent-core.yml`) for Voice Bridge, SIP ingress, wallet, ranking, vendor, buyer, WhatsApp bot, and the broker orchestrator. These mirror the environment variables documented in `.env`/`docs/env/env.sample`.
- Admin console exposes new “Live Calls”, “Leads”, and “Marketplace” pages. Smoke-test plan: hit `/live-calls`, `/leads`, `/marketplace` with mocks disabled, confirm the integrations banner reports `status=ok`, and CSV exports download successfully.
- Voice Bridge now serves `/analytics/live-calls`; verify the endpoint returns JSON with `calls` and `generatedAt` and that opt-outs/hand-offs are surfaced.
- Marketplace summary API (`/api/marketplace`) aggregates ranking, intents, and purchases by calling the new services. Acceptance tests for ranking, opt-outs, payments, and ledger invariants live alongside the service packages (`services/*/test`).
- Grafana dashboards (`dashboards/phase4/*.json`) and Kafka topic manifests (`infrastructure/kafka/topics.yaml`) document the monitoring footprint—import them into the observability stack during Phase 6 cut-over.
