{
  "version": "1.0.0",
  "name": "web-marketplace",
  "description": "Strict Moltbot contract for anonymous web marketplace chat plans. All responses must be a single JSON object that names one or more actions below and nothing else.",
  "max_questions_per_turn": 3,
  "constraints": [
    "notify_top_targets may emit at most 10 notification objects per post",
    "ask_user can never be issued more than three times in the same turn",
    "no availability or price claims may be made unless the listing/vender explicitly confirmed",
    "Moltbot must never send prose or chat directlyâ€”only validated plans conforming to this schema"
  ],
  "actions": {
    "ask_user": {
      "description": "Request a specific piece of missing information from the user.",
      "schema": {
        "type": "object",
        "properties": {
          "question": { "type": "string" },
          "target_fields": {
            "type": "array",
            "items": { "enum": ["type", "category", "title", "description", "price_min", "price_max", "currency", "location_text", "geo", "media_urls", "status"] }
          },
          "options": { "type": "array", "items": { "type": "string" } },
          "context": { "type": "string" }
        },
        "required": ["question", "target_fields"],
        "additionalProperties": false
      }
    },
    "update_post": {
      "description": "Persist captured fields into the Supabase market_posts record.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "fields": {
            "type": "object",
            "properties": {
              "type": { "enum": ["buy", "sell"] },
              "category": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" },
              "price_min": { "type": "integer", "minimum": 0 },
              "price_max": { "type": "integer", "minimum": 0 },
              "currency": { "type": "string" },
              "location_text": { "type": "string" },
              "geo": {
                "type": "object",
                "properties": {
                  "latitude": { "type": "number" },
                  "longitude": { "type": "number" }
                },
                "required": ["latitude", "longitude"],
                "additionalProperties": false
              },
              "media_urls": {
                "type": "array",
                "items": { "type": "string", "format": "uri" }
              },
              "status": { "enum": ["draft", "posted", "matched", "closed"] }
            },
            "additionalProperties": false
          }
        },
        "required": ["post_id", "fields"],
        "minProperties": 2
      }
    },
    "post_now": {
      "description": "Transition a drafted post to a posted state.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "status": { "enum": ["posted", "matched", "closed"] },
          "posted_at": { "type": "string", "format": "date-time" }
        },
        "required": ["post_id", "status"],
        "additionalProperties": false
      }
    },
    "suggest_matches": {
      "description": "Generate a ranked list of match suggestions with explainable reasons.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "matches": {
            "type": "array",
            "minItems": 1,
            "maxItems": 10,
            "items": {
              "type": "object",
              "properties": {
                "match_type": { "enum": ["internal_listing", "vendor_db", "external_feed"] },
                "target_id": { "type": "string", "format": "uuid" },
                "score": { "type": "number" },
                "reasons": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "code": { "type": "string" },
                      "description": { "type": "string" },
                      "score_delta": { "type": "number" }
                    },
                    "required": ["code", "description"],
                    "additionalProperties": false
                  },
                  "minItems": 1
                }
              },
              "required": ["match_type", "target_id", "score", "reasons"],
              "additionalProperties": false
            }
          }
        },
        "required": ["post_id", "matches"],
        "additionalProperties": false
      }
    },
    "notify_top_targets": {
      "description": "Queue notifications for up to 10 prioritized targets.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "targets": {
            "type": "array",
            "maxItems": 10,
            "items": {
              "type": "object",
              "properties": {
                "target_type": { "enum": ["seller_session", "buyer_session", "vendor", "lead"] },
                "target_id": { "type": "string", "format": "uuid" },
                "channel": { "enum": ["web", "whatsapp", "email"] },
                "payload": { "type": "object" }
              },
              "required": ["target_type", "target_id", "channel", "payload"],
              "additionalProperties": false
            }
          }
        },
        "required": ["post_id", "targets"],
        "additionalProperties": false
      }
    },
    "show_feed_options": {
      "description": "Expose curated external feed items as discovery links.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "feed_items": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "feed_item_id": { "type": "string", "format": "uuid" },
                "source": { "type": "string" },
                "title": { "type": "string" },
                "url": { "type": "string", "format": "uri" },
                "snippet": { "type": "string" },
                "confidence": { "type": "number" }
              },
              "required": ["feed_item_id", "source", "title", "url"],
              "additionalProperties": false
            }
          }
        },
        "required": ["post_id", "feed_items"],
        "additionalProperties": false
      }
    },
    "handoff_to_whatsapp": {
      "description": "When WhatsApp opt-in exists, request a sanctioned handoff.",
      "schema": {
        "type": "object",
        "properties": {
          "post_id": { "type": "string", "format": "uuid" },
          "recipient_id": { "type": "string", "format": "uuid" },
          "template": { "type": "string" },
          "context": { "type": "object" }
        },
        "required": ["post_id", "recipient_id", "template"],
        "additionalProperties": false
      }
    },
    "moderate_or_block": {
      "description": "Raise a moderation event or temporarily block an abusive session.",
      "schema": {
        "type": "object",
        "properties": {
          "session_id": { "type": "string", "format": "uuid" },
          "post_id": { "type": "string", "format": "uuid" },
          "action": { "enum": ["moderate", "block", "escalate"] },
          "reason": { "type": "string" },
          "severity": { "type": "string", "enum": ["low", "medium", "high"] }
        },
        "required": ["session_id", "action", "reason"],
        "additionalProperties": false
      }
    }
  }
}
