name: Admin App CI
on:
  push:
  pull_request:
  workflow_dispatch:
permissions:
  contents: read

jobs:
  admin-app:
    name: Build, Typecheck, Lint, Test (admin-app)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile
      - name: Typecheck admin-app (scoped)
        run: pnpm -F @easymo/admin-app run type-check
      - name: Lint admin-app
        run: pnpm -F @easymo/admin-app run lint --no --max-warnings=0
      - name: Test admin-app
        run: pnpm -F @easymo/admin-app test -- --run
      - name: Build shared package for admin
        run: pnpm -F @va/shared build
      - name: Build admin-app (Next)
        env:
          NEXT_PUBLIC_USE_MOCKS: 'false'
        run: pnpm -F @easymo/admin-app build

  sql-migrations:
    name: SQL Migrations Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Check migration formatting
        run: deno run --allow-read tools/sql/check_migrations.ts
        continue-on-error: true

  sql-policy-audit:
    name: SQL Policy Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Audit RLS policies
        run: deno run --allow-read tools/sql/policy_audit.ts
        continue-on-error: true

  synthetic-checks:
    name: Synthetic Admin Checks
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    env:
      ADMIN_BASE_URL: ${{ secrets.ADMIN_BASE_URL }}
      ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Run synthetic checks
        if: ${{ env.ADMIN_BASE_URL != '' && env.ADMIN_API_TOKEN != '' }}
        run: deno run --allow-env --allow-net tools/monitoring/admin/synthetic-checks.ts
      - name: Skip synthetic checks (missing secrets)
        if: ${{ !(env.ADMIN_BASE_URL != '' && env.ADMIN_API_TOKEN != '') }}
        run: echo "Skipping synthetic checks; secrets not configured."
