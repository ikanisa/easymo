name: Admin App CI
on:
  push:
  pull_request:
permissions:
  contents: read

jobs:
  admin-app:
    name: Build, Typecheck, Lint, Test (admin-app)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared packages
        run: pnpm --filter @va/shared build && pnpm --filter @easymo/commons build
      - name: Typecheck (API + lib)
        working-directory: admin-app
        run: npx tsc -p tsconfig.ci.json --noEmit
        continue-on-error: true
      - name: Lint
        working-directory: admin-app
        run: npm run lint -- --max-warnings=0
      - name: Run tests
        working-directory: admin-app
        run: npm test -- --run
      - name: Build
        working-directory: admin-app
        env:
          # Ensure mocks are off for production-like builds
          NEXT_PUBLIC_USE_MOCKS: 'false'
          # Required for Next.js build (inlined at build time)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm run build


  sql-migrations:
    name: SQL Migrations Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Check migration formatting
        run: deno run --allow-read tools/sql/check_migrations.ts
        continue-on-error: true

  sql-policy-audit:
    name: SQL Policy Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Audit RLS policies
        run: deno run --allow-read tools/sql/policy_audit.ts
        continue-on-error: true

  synthetic-checks:
    name: Synthetic Admin Checks
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    env:
      ADMIN_BASE_URL: ${{ secrets.ADMIN_BASE_URL }}
      ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Run synthetic checks
        if: ${{ env.ADMIN_BASE_URL != '' && env.ADMIN_API_TOKEN != '' }}
        run: deno run --allow-env --allow-net tools/monitoring/admin/synthetic-checks.ts
      - name: Skip synthetic checks (missing secrets)
        if: ${{ !(env.ADMIN_BASE_URL != '' && env.ADMIN_API_TOKEN != '') }}
        run: echo "Skipping synthetic checks; secrets not configured."
