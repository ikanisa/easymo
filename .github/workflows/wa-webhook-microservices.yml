name: WA-Webhook Microservices CI

on:
  push:
    paths:
      - 'supabase/functions/wa-webhook-*/**'
      - 'supabase/functions/_shared/wa-webhook-packages/**'
  pull_request:
    paths:
      - 'supabase/functions/wa-webhook-*/**'
      - 'supabase/functions/_shared/wa-webhook-packages/**'

jobs:
  test-shared-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x
      
      - name: Test shared packages
        run: |
          cd supabase/functions/_shared/wa-webhook-packages
          for pkg in shared router observability; do
            echo "Testing $pkg..."
            cd $pkg
            deno test --allow-all
            cd ..
          done

  test-services:
    runs-on: ubuntu-latest
    needs: test-shared-packages
    strategy:
      matrix:
        service: 
          - wa-webhook-core
          - wa-webhook-mobility
          - wa-webhook-property
          - wa-webhook-marketplace
          - wa-webhook-jobs
          - wa-webhook-wallet
          - wa-webhook-ai-agents
    steps:
      - uses: actions/checkout@v3
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x
      
      - name: Test ${{ matrix.service }}
        run: |
          cd supabase/functions/${{ matrix.service }}
          deno test --allow-all
      
      - name: Check TypeScript
        run: |
          cd supabase/functions/${{ matrix.service }}
          deno check index.ts

  deploy:
    runs-on: ubuntu-latest
    needs: test-services
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: supabase/setup-cli@v1
      
      - name: Deploy functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          for service in wa-webhook-core wa-webhook-mobility wa-webhook-property wa-webhook-marketplace wa-webhook-jobs wa-webhook-wallet wa-webhook-ai-agents; do
            echo "Deploying $service..."
            supabase functions deploy $service --project-ref $SUPABASE_PROJECT_ID
          done
