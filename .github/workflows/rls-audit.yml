name: RLS Security Audit

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'scripts/sql/**'
  schedule:
    - cron: '0 6 * * 1' # Weekly Monday 6am UTC
  workflow_dispatch: # Manual trigger

jobs:
  rls-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Start Supabase (local)
        run: |
          supabase start
          echo "Supabase started locally"
      
      - name: Run migrations
        run: |
          supabase db push
          echo "Migrations applied"
      
      - name: Run RLS Audit
        id: rls-audit
        run: |
          # Get local database URL
          DB_URL=$(supabase status -o json | jq -r '.DB_URL')
          
          # Run audit
          psql "$DB_URL" -f scripts/sql/rls-audit.sql > rls-audit-results.txt
          
          # Display results
          cat rls-audit-results.txt
          
          # Check for critical issues
          if grep -q "NO RLS ENABLED" rls-audit-results.txt; then
            echo "::warning::Tables found without RLS policies"
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: rls-audit-report-${{ github.sha }}
          path: rls-audit-results.txt
          retention-days: 30
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.rls-audit.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('rls-audit-results.txt', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ RLS Audit Findings\n\nTables without RLS policies detected:\n\n\`\`\`\n${results}\n\`\`\`\n\nPlease review and add appropriate RLS policies before merging.`
            });
      
      - name: Stop Supabase
        if: always()
        run: supabase stop
