name: Admin App Visual Regression & A11y

on:
  pull_request:
    paths:
      - 'admin-app/components/**'
      - 'admin-app/app/**'
      - 'admin-app/tests/e2e/playwright/**'
      - '.github/workflows/admin-app-visual.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build shared packages
        run: pnpm --filter @va/shared build && pnpm --filter @easymo/commons build
        
      - name: Install Playwright browsers
        working-directory: admin-app
        run: npx playwright install --with-deps chromium firefox
        
      - name: Build admin app
        working-directory: admin-app
        env:
          NEXT_PUBLIC_USE_MOCKS: 'true'
          NEXT_PUBLIC_SUPABASE_URL: 'https://mock.supabase.co'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-anon-key'
        run: npm run build
        
      - name: Start admin app
        working-directory: admin-app
        env:
          PORT: 5173
        run: npm start &
        
      - name: Wait for app to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do sleep 1; done'
        
      - name: Run visual regression tests
        working-directory: admin-app/tests/e2e/playwright
        env:
          ADMIN_APP_BASE_URL: 'http://localhost:5173'
        run: npx playwright test --project=chromium navigation-visual.e2e.spec.ts
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: admin-app/tests/e2e/playwright/test-results/
          retention-days: 30
          
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-screenshots
          path: admin-app/tests/e2e/playwright/**/*.png
          retention-days: 30

  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build shared packages
        run: pnpm --filter @va/shared build && pnpm --filter @easymo/commons build
        
      - name: Install Playwright and axe
        working-directory: admin-app
        run: |
          npx playwright install --with-deps chromium
          npm install -D @axe-core/playwright
        
      - name: Build admin app
        working-directory: admin-app
        env:
          NEXT_PUBLIC_USE_MOCKS: 'true'
          NEXT_PUBLIC_SUPABASE_URL: 'https://mock.supabase.co'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-anon-key'
        run: npm run build
        
      - name: Start admin app
        working-directory: admin-app
        env:
          PORT: 5173
        run: npm start &
        
      - name: Wait for app to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do sleep 1; done'
        
      - name: Run accessibility audit
        working-directory: admin-app/tests/e2e/playwright
        env:
          ADMIN_APP_BASE_URL: 'http://localhost:5173'
        run: npx playwright test --project=chromium --grep="@accessibility"
        continue-on-error: true
        
      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: a11y-report
          path: admin-app/tests/e2e/playwright/test-results/
          retention-days: 30

  comment-results:
    name: Comment PR with Results
    needs: [visual-regression, accessibility]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          
      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            
            let comment = '## ðŸŽ¨ Visual Regression & Accessibility Test Results\n\n';
            
            // Add visual regression status
            comment += '### Visual Regression Tests\n';
            comment += 'Screenshots have been captured and compared. ';
            comment += 'Check the artifacts for details.\n\n';
            
            // Add accessibility status
            comment += '### Accessibility Tests\n';
            comment += 'WCAG 2.1 Level AA compliance checked. ';
            comment += 'Review the accessibility report in artifacts.\n\n';
            
            comment += '### ðŸ“Š Artifacts\n';
            comment += '- [Playwright Report](../../actions/runs/${{ github.run_id }})\n';
            comment += '- [Screenshots](../../actions/runs/${{ github.run_id }})\n';
            comment += '- [A11y Report](../../actions/runs/${{ github.run_id }})\n';
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: comment
            });
