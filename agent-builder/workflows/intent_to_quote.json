{
  "name": "intent_to_quote",
  "description": "Capture intent on WhatsApp, ping vendors, assemble shortlist, and record decision.",
  "states": ["INTENT_CREATED","VENDOR_PINGING","OFFERS_COLLECTED","QUOTE_ISSUED","DECIDED"],
  "initial_state": "INTENT_CREATED",
  "transitions": [
    {
      "from": "INTENT_CREATED",
      "to": "VENDOR_PINGING",
      "actions": [
        { "tool": "marketplace.create_intent", "params": {"tenantId": "${TENANT_ID}", "buyerId": "${BUYER_ID}", "channel": "whatsapp", "payload": "${INTENT_PAYLOAD}"} }
      ]
    },
    {
      "from": "VENDOR_PINGING",
      "to": "OFFERS_COLLECTED",
      "guard": { "type": "min_responses_or_timeout", "min": 2, "timeout_ms": 300000 },
      "actions": [
        { "tool": "ranking.list_candidates", "params": {"tenantId":"${TENANT_ID}", "categories": "${CATEGORIES}", "region": "${REGION}"} },
        { "tool": "vendor.create_quote", "fan_out": true, "items": "${CANDIDATE_VENDORS}", "params_template": {"tenantId":"${TENANT_ID}", "vendorId":"${item.id}", "intentId":"${INTENT_ID}", "price": "${PRICE}", "currency": "USD"}, "max_parallel": 5 }
      ]
    },
    {
      "from": "OFFERS_COLLECTED",
      "to": "QUOTE_ISSUED",
      "actions": [
        { "tool": "broker.send_wa_template", "params": {"to": "${BUYER_MSISDN}", "template": {"name": "DECISION_PACK", "language": "en", "components": "${SHORTLIST_COMPONENTS}"}} }
      ]
    },
    {
      "from": "QUOTE_ISSUED",
      "to": "DECIDED",
      "actions": [
        { "tool": "attribution.evaluate", "params": {"quoteId": "${QUOTE_ID}", "referrals": "${REFERRALS}", "events": "${DECISION_EVENTS}"} }
      ]
    }
  ]
}

